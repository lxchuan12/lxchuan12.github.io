<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一文读懂vuex4源码，原来provide/inject就是妙用了原型链？ | 若川的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="mainfest" href="/mainfest.json">
    <meta name="description" content="若川，微信搜索「若川视野」关注我，长期交流学习。写有《学习源码整体架构系列》。包含jquery源码、underscore源码、lodash源码、sentry源码、vuex源码、axios源码、koa源码、redux源码。前端路上，PPT爱好者，所知甚少，唯善学。">
    
    <link rel="preload" href="/assets/css/0.styles.0ad39d54.css" as="style"><link rel="preload" href="/assets/js/app.aca9512d.js" as="script"><link rel="preload" href="/assets/js/2.bb92df1b.js" as="script"><link rel="preload" href="/assets/js/17.8efc7454.js" as="script"><link rel="preload" href="/assets/js/25.52480ac0.js" as="script"><link rel="prefetch" href="/assets/js/10.867aafa9.js"><link rel="prefetch" href="/assets/js/11.99f105e9.js"><link rel="prefetch" href="/assets/js/12.26877e09.js"><link rel="prefetch" href="/assets/js/13.80775f22.js"><link rel="prefetch" href="/assets/js/14.a5598303.js"><link rel="prefetch" href="/assets/js/15.2745a636.js"><link rel="prefetch" href="/assets/js/16.9a3ee0bd.js"><link rel="prefetch" href="/assets/js/18.71996f86.js"><link rel="prefetch" href="/assets/js/19.501576a4.js"><link rel="prefetch" href="/assets/js/20.2085684b.js"><link rel="prefetch" href="/assets/js/21.8a4e0b44.js"><link rel="prefetch" href="/assets/js/22.cb3784cb.js"><link rel="prefetch" href="/assets/js/23.87471f52.js"><link rel="prefetch" href="/assets/js/24.6fd95574.js"><link rel="prefetch" href="/assets/js/26.8368f729.js"><link rel="prefetch" href="/assets/js/27.fc5647ac.js"><link rel="prefetch" href="/assets/js/28.a274b94e.js"><link rel="prefetch" href="/assets/js/29.78f9ce2a.js"><link rel="prefetch" href="/assets/js/3.4e3e8054.js"><link rel="prefetch" href="/assets/js/30.e0b04869.js"><link rel="prefetch" href="/assets/js/31.f6443387.js"><link rel="prefetch" href="/assets/js/32.7eb37368.js"><link rel="prefetch" href="/assets/js/33.7f15a291.js"><link rel="prefetch" href="/assets/js/34.46c48e5b.js"><link rel="prefetch" href="/assets/js/35.d3dece26.js"><link rel="prefetch" href="/assets/js/36.7cf82dc7.js"><link rel="prefetch" href="/assets/js/37.9a2402be.js"><link rel="prefetch" href="/assets/js/38.d6b8cfb2.js"><link rel="prefetch" href="/assets/js/39.221a4fa4.js"><link rel="prefetch" href="/assets/js/4.24232fe9.js"><link rel="prefetch" href="/assets/js/40.2f5865c2.js"><link rel="prefetch" href="/assets/js/41.320c1cbe.js"><link rel="prefetch" href="/assets/js/42.7527ffe0.js"><link rel="prefetch" href="/assets/js/43.fe43b1cb.js"><link rel="prefetch" href="/assets/js/44.8ee2bda7.js"><link rel="prefetch" href="/assets/js/45.5089d816.js"><link rel="prefetch" href="/assets/js/46.c4643ea2.js"><link rel="prefetch" href="/assets/js/47.e7978d5f.js"><link rel="prefetch" href="/assets/js/48.f83fcac1.js"><link rel="prefetch" href="/assets/js/49.366b68aa.js"><link rel="prefetch" href="/assets/js/5.e1d26941.js"><link rel="prefetch" href="/assets/js/50.dfc5606e.js"><link rel="prefetch" href="/assets/js/51.8b5c616f.js"><link rel="prefetch" href="/assets/js/52.6c0ff3a0.js"><link rel="prefetch" href="/assets/js/53.bf580946.js"><link rel="prefetch" href="/assets/js/54.fdc247a0.js"><link rel="prefetch" href="/assets/js/55.e278588b.js"><link rel="prefetch" href="/assets/js/56.45d95e6b.js"><link rel="prefetch" href="/assets/js/6.e69ca8ad.js"><link rel="prefetch" href="/assets/js/7.016c39b8.js"><link rel="prefetch" href="/assets/js/8.d1912b52.js"><link rel="prefetch" href="/assets/js/9.e247d6b7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ad39d54.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">若川的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://image-static.segmentfault.com/355/182/3551821948-5df888aa1dc88_articlex" target="_blank" rel="noopener noreferrer" class="nav-link external">
  公众号：若川视野
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/" class="nav-link">
  目录
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="/poetry/2012-2016/" class="nav-link">
  曾经写的&quot;诗词&quot;
</a></div><div class="nav-item"><a href="https://github.com/lxchuan12/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/1415826704971918/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.zhihu.com/people/lxchuan12/activities" target="_blank" rel="noopener noreferrer" class="nav-link external">
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.yuque.com/lxchuan12/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://segmentfault.com/u/lxchuan12/articles" target="_blank" rel="noopener noreferrer" class="nav-link external">
  segmentFault
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://weibo.com/lxchuan12" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://www.jianshu.com/users/83129d433d72/latest_articles" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友链" class="dropdown-title"><span class="title">友链</span> <span class="arrow down"></span></button> <button type="button" aria-label="友链" class="mobile-dropdown-title"><span class="title">友链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shanyue.tech" target="_blank" rel="noopener noreferrer" class="nav-link external">
  山月
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://lucifer.ren" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucifer
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://hungryturbo.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  童欧巴
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.scarsu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  scarsu
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://mtc.nofwl.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lencx的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://coder.itclan.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  itclanCoder
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ruizhengyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  编程之上
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://image-static.segmentfault.com/355/182/3551821948-5df888aa1dc88_articlex" target="_blank" rel="noopener noreferrer" class="nav-link external">
  公众号：若川视野
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/" class="nav-link">
  目录
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="/poetry/2012-2016/" class="nav-link">
  曾经写的&quot;诗词&quot;
</a></div><div class="nav-item"><a href="https://github.com/lxchuan12/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/1415826704971918/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.zhihu.com/people/lxchuan12/activities" target="_blank" rel="noopener noreferrer" class="nav-link external">
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.yuque.com/lxchuan12/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://segmentfault.com/u/lxchuan12/articles" target="_blank" rel="noopener noreferrer" class="nav-link external">
  segmentFault
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://weibo.com/lxchuan12" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://www.jianshu.com/users/83129d433d72/latest_articles" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友链" class="dropdown-title"><span class="title">友链</span> <span class="arrow down"></span></button> <button type="button" aria-label="友链" class="mobile-dropdown-title"><span class="title">友链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shanyue.tech" target="_blank" rel="noopener noreferrer" class="nav-link external">
  山月
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://lucifer.ren" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lucifer
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://hungryturbo.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  童欧巴
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.scarsu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  scarsu
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://mtc.nofwl.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lencx的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://coder.itclan.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  itclanCoder
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ruizhengyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  编程之上
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学习源码系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuex4/" aria-current="page" class="active sidebar-link">一文读懂vuex4源码，原来provide/inject就是妙用了原型链？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuex4/#_1-前言" class="sidebar-link">1. 前言</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuex4/#_1-1-本文阅读最佳方式" class="sidebar-link">1.1 本文阅读最佳方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuex4/#_2-vuex-原理简述" class="sidebar-link">2. Vuex 原理简述</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_3-vuex-4-重大改变" class="sidebar-link">3. Vuex 4 重大改变</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuex4/#_3-1-安装过程" class="sidebar-link">3.1 安装过程</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_3-2-核心模块导出了-createlogger-函数" class="sidebar-link">3.2 核心模块导出了 createLogger 函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-从源码角度看-vuex-4-重大变化" class="sidebar-link">4. 从源码角度看 Vuex 4 重大变化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuex4/#_4-1-chrome-调试-vuex-4-源码准备工作" class="sidebar-link">4.1 chrome 调试 Vuex 4 源码准备工作</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-2-vuex-createstore-函数" class="sidebar-link">4.2 Vuex.createStore 函数</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-3-app-use-方法" class="sidebar-link">4.3 app.use() 方法</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-4-install-函数" class="sidebar-link">4.4 install 函数</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-5-composition-api-中如何使用vuex-4" class="sidebar-link">4.5 composition API 中如何使用Vuex 4</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-6-createcomponentinstance-创建组件实例" class="sidebar-link">4.6 createComponentInstance 创建组件实例</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_4-7-getcurrentinstance-获取当前实例对象" class="sidebar-link">4.7 getCurrentInstance 获取当前实例对象</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuex4/#_5-解答下开头提出的5个问题" class="sidebar-link">5. 解答下开头提出的5个问题</a></li><li class="sidebar-sub-header"><a href="/vuex4/#_6-总结" class="sidebar-link">6. 总结</a></li><li class="sidebar-sub-header"><a href="/vuex4/#关于" class="sidebar-link">关于</a></li><li class="sidebar-sub-header"><a href="/vuex4/#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/open-in-editor/" class="sidebar-link">据说 99% 的人不知道 vue-devtools 还能直接打开对应组件文件？本文原理揭秘</a></li><li><a href="/redux/" class="sidebar-link">学习 redux 源码整体架构，深入理解 redux 及其中间件原理</a></li><li><a href="/koa/" class="sidebar-link">学习 koa 源码的整体架构，浅析koa洋葱模型原理和co原理</a></li><li><a href="/axios/" class="sidebar-link">学习 axios 源码整体架构，打造属于自己的请求库</a></li><li><a href="/vuex/" class="sidebar-link">学习 vuex 源码整体架构，打造属于自己的状态管理库</a></li><li><a href="/sentry/" class="sidebar-link">学习 sentry 源码整体架构，打造属于自己的前端异常监控SDK</a></li><li><a href="/lodash/" class="sidebar-link">学习 lodash  源码整体架构，打造属于自己的函数式编程类库</a></li><li><a href="/underscore/" class="sidebar-link">学习underscore源码整体架构，打造属于自己的函数式编程类库</a></li><li><a href="/jquery/" class="sidebar-link">学习 jQuery 源码整体架构，打造属于自己的 js 类库</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试官问系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>历史文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>曾经写的&quot;诗词&quot;</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>年度总结</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>关于</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一文读懂vuex4源码-原来provide-inject就是妙用了原型链"><a href="#一文读懂vuex4源码-原来provide-inject就是妙用了原型链" class="header-anchor">#</a> 一文读懂vuex4源码，原来provide/inject就是妙用了原型链？</h1> <h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1. 前言</h2> <blockquote><p>你好，我是<a href="https://lxchuan12.gitee.io" target="_blank" rel="noopener noreferrer">若川<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，微信搜索<a href="https://mp.weixin.qq.com/s/c3hFML3XN9KCUetDOZd-DQ" target="_blank" rel="noopener noreferrer">「若川视野」<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>关注我，专注前端技术分享，一个愿景是帮助5年内前端开阔视野走向前列的公众号。欢迎加我微信<code>ruochuan12</code>，长期交流学习。</p></blockquote> <blockquote><p>这是<code>学习源码整体架构系列</code> 之 vuex4 源码（第十篇）。学习源码整体架构系列文章(<a href="https://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650746362&amp;idx=1&amp;sn=afe3a26cdbde1d423aae4fa99355f369&amp;chksm=88662e76bf11a760a7f0a8565b9e8d52f5e4f056dc2682f213eec6475127d71f6f1d203d6c3a&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">有哪些必看的JS库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)：<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744496&amp;idx=1&amp;sn=0f149e9436cb77bf9fc1bfb47aedd334&amp;chksm=8866253cbf11ac2a53b385153cd8e9a0c4018b6b566750cf0b5d61d17afa2e90b52d36db8054&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">jQuery<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744505&amp;idx=1&amp;sn=26801ad6c2a5eb9cf64e7556b6478d39&amp;chksm=88662535bf11ac23eea3f76335f6777e2acbf4ee660b5616148e14ffbefc0e8520806db21056&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">underscore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744514&amp;idx=1&amp;sn=776336d888d06bfe72cb4d5b07a4b90c&amp;chksm=8866254ebf11ac5822fc078082603f77a4b4d9b487c9f4d7069acb12c727c46c75946fa9b0cd&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">lodash<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744551&amp;idx=1&amp;sn=4d79c2fa97d7c737aab70055c7ec7fa3&amp;chksm=8866256bbf11ac7d9e2269f3638a705d5e5f45056d53ad2faf17b814e4c46ec6b0ba52571bde&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">sentry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744584&amp;idx=1&amp;sn=b14f8a762f132adcf0f7e3e075ee2ded&amp;chksm=88662484bf11ad922ed27d45873af838298949eea381545e82a511cabf0c6fc6876a8370c6fb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">vuex<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744604&amp;idx=1&amp;sn=51d8d865c9848fd59f7763f5fb9ce789&amp;chksm=88662490bf11ad86061ae76ff71a1177eeddab02c38d046eecd0e1ad25dc16f7591f91e9e3b2&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">axios<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744703&amp;idx=1&amp;sn=cfb9580241228993e4d376017234ff79&amp;chksm=886624f3bf11ade5f5e37520f6b1291417bcea95f222906548b863f4b61d20e7508eb419eb85&amp;token=192125900&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">koa<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650745007&amp;idx=1&amp;sn=1fd6f3caeff6ab61b8d5f644a1dbb7df&amp;chksm=88662b23bf11a23573509a01f941d463b0c61e890b2069427c78c26296197077da359c522fe8&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">redux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650751278&amp;idx=1&amp;sn=3ac07b110e84e3ded5fa4ec4407ce13b&amp;chksm=886642a2bf11cbb4cea35f0d208815c39c9cd13a0522e7cdc4a466bc55cb5b3071143a38bb04&amp;token=1828368955&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">vue-devtools 直接打开文件功能揭秘<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></blockquote> <blockquote><p><strong>10篇源码系列文章小成就达成</strong>，从19年7月开始写，19年写了6篇，20年写了2篇，今年写了2篇。算是一个完结吧。短时间内应该暂时不更新这个系列了。主要是投入的时间和精力比较多，看的人很少，得到的反馈也比较少。之后先写其他文章吧。欢迎持续关注我（<a href="https://lxchuan12.gitee.io" target="_blank" rel="noopener noreferrer">若川<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></blockquote> <blockquote><p><a href="https://github.com/lxchuan12/vuex4-analysis.git" target="_blank" rel="noopener noreferrer">本文仓库地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：<code>git clone https://github.com/lxchuan12/vuex4-analysis.git</code>，本文最佳阅读方式，克隆仓库自己动手调试，容易吸收消化。</p></blockquote> <blockquote><p><strong>要是有人说到怎么读源码，正在读文章的你能推荐我的源码系列文章，那真是无以为报啊</strong>。</p></blockquote> <p>我的文章，尽量写得让想看源码又不知道怎么看的读者能看懂。我都是推荐使用<strong>搭建环境断点调试源码学习</strong>，<strong>哪里不会点哪里</strong>，<strong>边调试边看，而不是硬看</strong>。正所谓：<strong>授人与鱼不如授人予渔</strong>。</p> <p>阅读本文后你将学到：</p> <ul><li><ol><li><code>git subtree</code> 管理子仓库</li></ol></li> <li><ol start="2"><li>如何学习<code>Vuex 4</code>源码、理解<code>Vuex</code>原理</li></ol></li> <li><ol start="3"><li><code>Vuex 4</code> 和 <code>Vuex 3</code> 的异同</li></ol></li> <li><ol start="4"><li><code>Vuex 4</code> <code>composition API</code> 如何使用</li></ol></li> <li><ol start="5"><li><code>Vue.provide / Vue.inject</code> API 使用和原理</li></ol></li> <li><ol start="6"><li>如何写一个 <code>Vue3</code> 插件</li></ol></li> <li>等等</li></ul> <p>如果对于谷歌浏览器调试还不是很熟悉的读者，可以看这篇文章<a href="https://mp.weixin.qq.com/s/lMlq4IKtHj2V3Hv2iB723w" target="_blank" rel="noopener noreferrer">chrome devtools source面板<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，写的很详细。顺带提一下，我打开的设置，source面板中支持展开搜索代码块（默认不支持），一图胜千言<img src="/assets/img/code-folding.d9330c61.png" alt="code-folding">。谷歌浏览器是我们前端常用的工具，所以建议大家深入学习，毕竟<strong>工欲善其事，必先利其器</strong>。</p> <p>之前写过<code>Vuex 3</code>的源码文章<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744584&amp;idx=1&amp;sn=b14f8a762f132adcf0f7e3e075ee2ded&amp;chksm=88662484bf11ad922ed27d45873af838298949eea381545e82a511cabf0c6fc6876a8370c6fb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">学习 vuex 源码整体架构，打造属于自己的状态管理库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://lxchuan12.gitee.io/vuex" target="_blank" rel="noopener noreferrer">若川的博客Vuex源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，仓库有很详细的注释和看源码方法，所以本文不会过多赘述与<code>Vuex 3</code>源码相同的地方。</p> <h3 id="_1-1-本文阅读最佳方式"><a href="#_1-1-本文阅读最佳方式" class="header-anchor">#</a> 1.1 本文阅读最佳方式</h3> <p>把我的<code>vuex4</code>源码仓库 <code>git clone https://github.com/lxchuan12/vuex4-analysis.git</code>克隆下来，顺便star一下我的<a href="https://github.com/lxchuan12/vuex4-analysis.git" target="_blank" rel="noopener noreferrer">vuex4源码学习仓库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>^_^。<strong>跟着文章节奏调试和示例代码调试，用chrome动手调试印象更加深刻</strong>。文章长段代码不用细看，可以调试时再细看。看这类源码文章百遍，可能不如自己多调试几遍，大胆猜测，小心求证。也欢迎加我微信交流<code>ruochuan12</code>。</p> <h2 id="_2-vuex-原理简述"><a href="#_2-vuex-原理简述" class="header-anchor">#</a> 2. Vuex 原理简述</h2> <p><strong>结论先行</strong>：<code>Vuex</code>原理可以拆解为三个关键点。
第一点、其实就是每个组件实例里都注入了<code>Store</code>实例。
第二点、<code>Store</code>实例中的各种方法都是为<code>Store</code>中的属性服务的。
第三点、<code>Store</code>中的属性变更触发视图更新。</p> <p>本文主要讲解第一点。第二点在我的上一篇文章<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&amp;mid=2650744584&amp;idx=1&amp;sn=b14f8a762f132adcf0f7e3e075ee2ded&amp;chksm=88662484bf11ad922ed27d45873af838298949eea381545e82a511cabf0c6fc6876a8370c6fb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">学习 vuex 源码整体架构，打造属于自己的状态管理库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>详细讲了，本文就不赘述了。第三点两篇文章都没有详细讲述。</p> <p>以下是一段简短的代码说明<code>Vuex</code>原理的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 简版</span>
<span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token string">'Store 实例'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__state <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 省略</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> rootInstance <span class="token operator">=</span> <span class="token punctuation">{</span>
  parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    store<span class="token operator">:</span> store<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> parentInstance <span class="token operator">=</span> <span class="token punctuation">{</span>
  parent<span class="token operator">:</span> rootInstance<span class="token punctuation">,</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    store<span class="token operator">:</span> store<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> childInstance1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  parent<span class="token operator">:</span> parentInstance<span class="token punctuation">,</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    store<span class="token operator">:</span> store<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> childInstance2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  parent<span class="token operator">:</span> parentInstance<span class="token punctuation">,</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    store<span class="token operator">:</span> store<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'我被修改了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// store Store {_state: &quot;我被修改了&quot;}</span>

<span class="token comment">// rootInstance、parentInstance、childInstance1、childInstance2 这些对象中的provides.store都改了。</span>
<span class="token comment">// 因为共享着同一个store对象。</span>
</code></pre></div><p><img src="/assets/img/components_provide.6bb18cde.png" alt="provide,inject示例图"></p> <p>看了上面的官方文档中的图，大概知道是用<code>provide</code>父级组件中提供<code>Store</code>实例，用<code>inject</code>来获取到<code>Store</code>实例。</p> <p>那么接下来，带着问题：</p> <p>1、为什么修改了实例<code>store</code>里的属性，变更后会触发视图更新。</p> <p>2、<code>Vuex4</code>作为<code>Vue</code>的插件如何实现和<code>Vue</code>结合的。</p> <p>3、<code>provide</code>、<code>inject</code>的如何实现的，每个组件如何获取到组件实例中的<code>Store</code>的。</p> <p>4、为什么每个组件对象里都有<code>Store</code>实例对象了(渲染组件对象过程)。</p> <p>5、为什么在组件中写的<code>provide</code>提供的数据，能被子级组件获取到。</p> <h2 id="_3-vuex-4-重大改变"><a href="#_3-vuex-4-重大改变" class="header-anchor">#</a> 3. Vuex 4 重大改变</h2> <p>在看源码之前，先来看下<code>Vuex 4</code>发布的<code>release</code>和官方文档迁移提到的重大改变，<a href="https://github.com/vuejs/vuex/releases/tag/v4.0.0" target="_blank" rel="noopener noreferrer">Vuex 4 release<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><a href="https://next.vuex.vuejs.org/zh/guide/migrating-to-4-0-from-3-x.html" target="_blank" rel="noopener noreferrer">从 3.x 迁移到 4.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>Vuex 4</code>的重点是兼容性。<code>Vuex 4</code>支持使用<code>Vue 3</code>开发，并且直接提供了和<code>Vuex 3</code>完全相同的<code>API</code>，因此用户可以在<code>Vue 3</code>项目中复用现有的<code>Vuex</code>代码。</p> <p>相比<code>Vuex 3</code>版本。主要有如下重大改变（其他的在上方链接中）：</p> <h3 id="_3-1-安装过程"><a href="#_3-1-安装过程" class="header-anchor">#</a> 3.1 安装过程</h3> <p><code>Vuex 3</code>是<code>Vue.use(Vuex)</code></p> <p><code>Vuex 4</code>则是<code>app.use(store)</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_3-2-核心模块导出了-createlogger-函数"><a href="#_3-2-核心模块导出了-createlogger-函数" class="header-anchor">#</a> 3.2 核心模块导出了 <code>createLogger</code> 函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
</code></pre></div><p><strong>接下来我们从源码的角度来看这些重大改变</strong>。</p> <h2 id="_4-从源码角度看-vuex-4-重大变化"><a href="#_4-从源码角度看-vuex-4-重大变化" class="header-anchor">#</a> 4. 从源码角度看 Vuex 4 重大变化</h2> <h3 id="_4-1-chrome-调试-vuex-4-源码准备工作"><a href="#_4-1-chrome-调试-vuex-4-源码准备工作" class="header-anchor">#</a> 4.1 chrome 调试 Vuex 4 源码准备工作</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> subtree <span class="token function">add</span> --prefix<span class="token operator">=</span>vuex https://github.com/vuejs/vuex.git <span class="token number">4.0</span>
</code></pre></div><p>这种方式保留了<code>vuex4</code>仓库的<code>git</code>记录信息。更多<code>git subtree</code>使用方式可以查看这篇文章<a href="https://segmentfault.com/a/1190000003969060" target="_blank" rel="noopener noreferrer">用 Git Subtree 在多个 Git 项目间双向同步子项目，附简明使用手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>作为读者朋友的你，只需克隆<a href="https://github.com/lxchuan12/vuex4-analysis.git" target="_blank" rel="noopener noreferrer">我的<code>Vuex 4</code>源码仓库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>https://github.com/lxchuan12/vuex4-analysis.git</code> 即可，也欢迎<code>star</code>一下。</p> <p>把<code>vuex/examples/webpack.config.js</code>，加个<code>devtool: 'source-map'</code>，这样就能开启<code>sourcemap</code>调试源码了。</p> <p>我们使用项目中的购物车的例子调试，贯穿全文。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> clone https://github.com/lxchuan12/vuex4-analysis.git
<span class="token builtin class-name">cd</span> vuex
<span class="token function">npm</span> i
<span class="token function">npm</span> run dev
<span class="token comment"># 打开 http://localhost:8080/</span>
<span class="token comment"># 选择 composition  购物车的例子 shopping-cart</span>
<span class="token comment"># 打开 http://localhost:8080/composition/shopping-cart/</span>
<span class="token comment"># 按 F12 打开调试工具，source面板 =&gt; page =&gt; webpack:// =&gt; .</span>
</code></pre></div><p>据说一图胜千言，这时简单截个调试的图。</p> <p><img src="/assets/img/debugger.348c763f.png" alt="vuex debugger"></p> <p>找到 <code>createStore</code>函数打上断点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./examples/composition/shopping-cart/store/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> createLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> cart <span class="token keyword">from</span> <span class="token string">'./modules/cart'</span>
<span class="token keyword">import</span> products <span class="token keyword">from</span> <span class="token string">'./modules/products'</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  modules<span class="token operator">:</span> <span class="token punctuation">{</span>
    cart<span class="token punctuation">,</span>
    products
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  strict<span class="token operator">:</span> debug<span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> debug <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>找到<code>app.js</code>入口，在<code>app.use(store)</code>、<code>app.mount('#app')</code>等打上断点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./examples/composition/shopping-cart/app.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./components/App.vue'</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> currency <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./currency'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><p>接下来，我们从<code>createApp({})</code>、<code>app.use(Store)</code>两个方面发散开来讲解。</p> <h3 id="_4-2-vuex-createstore-函数"><a href="#_4-2-vuex-createstore-函数" class="header-anchor">#</a> 4.2 Vuex.createStore 函数</h3> <p>相比 <code>Vuex 3</code> 中，<code>new Vuex.Store</code>，其实是一样的。只不过为了和<code>Vue 3</code> 统一，<code>Vuex 4</code> 额外多了一个 <code>createStore</code> 函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStore</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 省略若干代码...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">.</span>state
    <span class="token function">resetStoreState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token comment">// 省略若干代码...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">resetStoreState</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略若干代码...</span>
  store<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token operator">:</span> state
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 省略若干代码...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>监测数据</strong></p> <p>和<code>Vuex 3</code>不同的是，监听数据不再是用<code>new Vue()</code>，而是<code>Vue 3</code>提供的<code>reactive</code>方法。</p> <p><code>Vue.reactive</code> 函数方法，本文就不展开讲解了。因为展开来讲，又可以写篇新的文章了。只需要知道主要功能是监测数据改变，变更视图即可。</p> <p>这也就算解答了开头提出的第一个问题。</p> <p>跟着断点我们继续看<code>app.use()</code>方法，<code>Vue</code>提供的插件机制。</p> <h3 id="_4-3-app-use-方法"><a href="#_4-3-app-use-方法" class="header-anchor">#</a> 4.3 app.use() 方法</h3> <p><code>use</code>做的事情说起来也算简单，把传递过来的插件添加插件集合中，到防止重复。</p> <p>执行插件，如果是对象，<code>install</code>是函数，则把参数app和其他参数传递给install函数执行。如果是函数直接执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.js</span>
<span class="token keyword">function</span> <span class="token function">createAppAPI</span><span class="token punctuation">(</span><span class="token parameter">render<span class="token punctuation">,</span> hydrate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token parameter">rootComponent<span class="token punctuation">,</span> rootProps <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 代码有删减</span>
      <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">plugin<span class="token punctuation">,</span> <span class="token operator">...</span>options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 已经有插件，并且 不是生产环境，报警告。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Plugin has already been applied to target app.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 插件的install 是函数，则添加插件，并执行 install 函数</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>install<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                installedPlugins<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 断点</span>
                plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token operator">...</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 插件本身 是函数，则添加插件，并执行 插件本身函数</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                installedPlugins<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">plugin</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token operator">...</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果都不是报警告</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">A plugin must either be a function or an object with an &quot;install&quot; </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 支持链式调用</span>
            <span class="token keyword">return</span> app<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
          <span class="token comment">// 省略... 后文再讲</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>上面代码中，断点这行<code>plugin.install(app, ...options);</code></p> <p>跟着断点走到下一步，<code>install</code>函数。</p> <h3 id="_4-4-install-函数"><a href="#_4-4-install-函数" class="header-anchor">#</a> 4.4 install 函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>
    <span class="token comment">// 省略若干代码...</span>
    <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> injectKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 为 composition API 中使用</span>
        <span class="token comment">//  可以传入 injectKey  如果没传取默认的 storeKey 也就是 store</span>
        app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>injectKey <span class="token operator">||</span> storeKey<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 为 option API 中使用</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略若干代码...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Vuex4</code>中的<code>install</code>函数相对比<code>Vuex3</code>中简单了许多。
第一句是给<code>Composition API</code>提供的。注入到根实例对象中。
第二句则是为<code>option API</code>提供的。</p> <p>接着断点这两句，按<code>F11</code>来看<code>app.provide</code>实现。</p> <h4 id="_4-4-1-app-provide"><a href="#_4-4-1-app-provide" class="header-anchor">#</a> 4.4.1 app.provide</h4> <p>简单来说就是给<code>context</code>的<code>provides</code>属性中加了<code>store</code> = <strong>Store实例对象</strong>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">provide</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已经有值了警告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> context<span class="token punctuation">.</span>provides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">App already provides property with key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">It will be overwritten with the new value.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TypeScript doesn't allow symbols as index type</span>
    <span class="token comment">// https://github.com/Microsoft/TypeScript/issues/24587</span>
    context<span class="token punctuation">.</span>provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着从上方代码中搜索<code>context</code>，可以发现这一句代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接着我们来看函数 <code>createAppContext</code>。
<code>context</code> 为上下文</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.js</span>
<span class="token keyword">function</span> <span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        app<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        config<span class="token operator">:</span> <span class="token punctuation">{</span>
            isNativeTag<span class="token operator">:</span> <span class="token constant">NO</span><span class="token punctuation">,</span>
            performance<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            globalProperties<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            optionMergeStrategies<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            isCustomElement<span class="token operator">:</span> <span class="token constant">NO</span><span class="token punctuation">,</span>
            errorHandler<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
            warnHandler<span class="token operator">:</span> <span class="token keyword">undefined</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        mixins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        components<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        directives<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        provides<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://v3.cn.vuejs.org/api/application-config.html" target="_blank" rel="noopener noreferrer">Vue3 文档应用配置(app.config)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_4-4-2-app-config-globalproperties"><a href="#_4-4-2-app-config-globalproperties" class="header-anchor">#</a> 4.4.2 app.config.globalProperties</h4> <p><a href="https://v3.cn.vuejs.org/api/application-config.html#globalproperties" target="_blank" rel="noopener noreferrer">app.config.globalProperties 官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>用法：</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'child-component'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">)</span> <span class="token comment">// '{}'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>也就能解释为什么每个组件都可以使用 <code>this.$store.xxx</code> 访问 <code>vuex</code>中的方法和属性了。</p> <p>也就是说在<code>appContext.provides</code>中注入了一个<strong>Store实例对象</strong>。这时也就是相当于根组件实例和<code>config</code>全局配置<code>globalProperties</code>中有了<strong>Store实例对象</strong>。</p> <p>至此我们就看完，<code>createStore(store)</code>，<code>app.use(store)</code>两个<code>API</code>。</p> <p><code>app.provide</code> 其实是用于<code>composition API</code>使用的。</p> <p>但这只是文档中这样说的，为什么就每个组件实例都能访问的呢，我们继续深入探究下原理。</p> <p>接下来，我们看下源码具体实现，为什么每个组件实例中都能获取到的。</p> <p>这之前先来看下组合式<code>API</code>中，我们如何使用<code>Vuex4</code>，这是线索。</p> <h3 id="_4-5-composition-api-中如何使用vuex-4"><a href="#_4-5-composition-api-中如何使用vuex-4" class="header-anchor">#</a> 4.5 composition API 中如何使用Vuex 4</h3> <p>接着我们找到如下文件，<code>useStore</code>是我们断点的对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./examples/composition/shopping-cart/components/ShoppingCart.vue</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> currency <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../currency'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 我加的这行代码</span>
    window<span class="token punctuation">.</span>ShoppingCartStore <span class="token operator">=</span> store<span class="token punctuation">;</span>
    <span class="token comment">// 省略了若干代码</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着断点按<code>F11</code>，单步调试，会发现最终是使用了<code>Vue.inject</code>方法。</p> <h4 id="_4-5-1-vuex-usestore-源码实现"><a href="#_4-5-1-vuex-usestore-源码实现" class="header-anchor">#</a> 4.5.1 Vuex.useStore 源码实现</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vuex/src/injectKey.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> storeKey <span class="token operator">=</span> <span class="token string">'store'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useStore</span> <span class="token punctuation">(</span><span class="token parameter">key <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> key <span class="token operator">:</span> storeKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-5-2-vue-inject-源码实现"><a href="#_4-5-2-vue-inject-源码实现" class="header-anchor">#</a> 4.5.2 Vue.inject 源码实现</h4> <p>接着看<code>inject</code>函数，看着代码很多，其实原理很简单，就是要找到我们用<code>provide</code>提供的值。</p> <p>如果没有父级，也就是根实例，就取实例对象中的<code>vnode.appContext.provides</code>。
否则就取父级中的<code>instance.parent.provides</code>的值。</p> <p>在<code>Vuex4</code>源码里则是：<code>Store</code>实例对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.js</span>
<span class="token keyword">function</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> defaultValue<span class="token punctuation">,</span> treatDefaultAsFactory <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fallback to `currentRenderingInstance` so that this can be called in</span>
    <span class="token comment">// a functional component</span>
    <span class="token comment">// 如果是被一个函数式组件调用则取 currentRenderingInstance</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> currentInstance <span class="token operator">||</span> currentRenderingInstance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// #2400</span>
        <span class="token comment">// to support `app.use` plugins,</span>
        <span class="token comment">// fallback to appContext's `provides` if the intance is at root</span>
        <span class="token keyword">const</span> provides <span class="token operator">=</span> instance<span class="token punctuation">.</span>parent <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>appContext <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>appContext<span class="token punctuation">.</span>provides
            <span class="token operator">:</span> instance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>provides <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> provides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TS doesn't allow symbol as index type</span>
            <span class="token keyword">return</span> provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果参数大于1个 第二个则是默认值 ，第三个参数是 true，并且第二个值是函数则执行函数。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> treatDefaultAsFactory <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span>
                <span class="token operator">?</span> <span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> defaultValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 警告没找到</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">injection &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果没有当前实例则说明则报警告。</span>
    <span class="token comment">// 也就是是说inject必须在setup中调用或者在函数式组件中使用</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">inject() can only be used inside setup() or functional components.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着我们继续来看<code>inject</code>的相对应的<code>provide</code>。</p> <h4 id="_4-5-3-vue-provide-源码实现"><a href="#_4-5-3-vue-provide-源码实现" class="header-anchor">#</a> 4.5.3  Vue.provide 源码实现</h4> <p><code>provide</code>函数作用其实也算简单，1、也就是给当前组件实例上的<code>provides</code>对象属性，添加键值对<code>key/value</code>。</p> <p>2、还有一个作用是当当前组件和父级组件的<code>provides</code>相同时，在当前组件实例中的<code>provides</code>对象和父级，则建立链接，也就是原型<code>[[prototype]]</code>，(<code>__proto__</code>)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.js</span>
<span class="token keyword">function</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">provide() can only be used inside setup().</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> provides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
        <span class="token comment">// by default an instance inherits its parent's provides object</span>
        <span class="token comment">// but when it needs to provide values of its own, it creates its</span>
        <span class="token comment">// own provides object using parent provides object as prototype.</span>
        <span class="token comment">// this way in `inject` we can simply look up injections from direct</span>
        <span class="token comment">// parent and let the prototype chain do the work.</span>
        <span class="token keyword">const</span> parentProvides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> currentInstance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parentProvides <span class="token operator">===</span> provides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            provides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>provides <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parentProvides<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TS doesn't allow symbol as index type</span>
        provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>provide</code>函数中的这段，可能不是那么好理解。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>parentProvides <span class="token operator">===</span> provides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    provides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>provides <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parentProvides<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们来举个例子消化一下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> currentInstance <span class="token operator">=</span> <span class="token punctuation">{</span> provides<span class="token operator">:</span> <span class="token punctuation">{</span> store<span class="token operator">:</span> <span class="token punctuation">{</span> __state<span class="token operator">:</span> <span class="token string">'Store实例'</span> <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> provides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
<span class="token comment">// 这句是我手动加的，在后文中则是创建实例时就是写的同一个对象，当然就会相等了。</span>
<span class="token keyword">var</span> parentProvides <span class="token operator">=</span> provides<span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>parentProvides <span class="token operator">===</span> provides<span class="token punctuation">)</span><span class="token punctuation">{</span>
    provides <span class="token operator">=</span>  currentInstance<span class="token punctuation">.</span>provides <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parentProvides<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>经过一次执行这个后，<code>currentInstance</code> 就变成了这样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
    __proto__ <span class="token operator">:</span> <span class="token punctuation">{</span> store<span class="token operator">:</span> <span class="token punctuation">{</span> __state<span class="token operator">:</span> <span class="token string">'Store实例'</span> <span class="token punctuation">}</span>  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行第二次时，<code>currentInstance</code> 则是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
    __proto__<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
        __proto__ <span class="token operator">:</span> <span class="token punctuation">{</span> store<span class="token operator">:</span> <span class="token punctuation">{</span> __state<span class="token operator">:</span> <span class="token string">'Store实例'</span> <span class="token punctuation">}</span>  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以此类推，多执行<code>provide</code>几次，原型链就越长。</p> <p>上文<code>inject</code>、<code>provide</code>函数中都有个变量<code>currentInstance</code>当前实例，那么当前实例对象是怎么来的呢。</p> <p>为什么每个组件就能访问到，依赖注入的思想。
有一个讨巧的方法，就是在文件<code>runtime-core.esm-bundler.js</code>中搜索<code>provides</code>，则能搜索到<code>createComponentInstance</code>函数</p> <p>接下来我们<code>createComponentInstance</code>函数如何创建组件实例。</p> <h3 id="_4-6-createcomponentinstance-创建组件实例"><a href="#_4-6-createcomponentinstance-创建组件实例" class="header-anchor">#</a> 4.6 createComponentInstance 创建组件实例</h3> <p>可以禁用其他断点，单独断点这里，
比如：<code>const appContext = (parent ? parent.appContext : vnode.appContext) || emptyAppContext;</code>
来看具体实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.js</span>
<span class="token keyword">const</span> emptyAppContext <span class="token operator">=</span> <span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> uid$<span class="token number">1</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> suspense</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">const</span> appContext <span class="token operator">=</span> <span class="token punctuation">(</span>parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>appContext <span class="token operator">:</span> vnode<span class="token punctuation">.</span>appContext<span class="token punctuation">)</span> <span class="token operator">||</span> emptyAppContext<span class="token punctuation">;</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
        uid<span class="token operator">:</span> uid$<span class="token number">1</span><span class="token operator">++</span><span class="token punctuation">,</span>
        vnode<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        appContext<span class="token punctuation">,</span>
        root<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        subTree<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
        provides<span class="token operator">:</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>provides <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>appContext<span class="token punctuation">.</span>provides<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    instance<span class="token punctuation">.</span>root <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>root <span class="token operator">:</span> instance<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>断点时会发现，根组件实例时<code>vnode</code>已经生成，至于是什么时候生成的，我整理了下简化版。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 把上文中的 appContext 赋值给了 `appContext`</span>
<span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">rootContainer<span class="token punctuation">,</span> isHydrate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// store app context on the root VNode.</span>
        <span class="token comment">// this will be set on the root instance on initial mount.</span>
        vnode<span class="token punctuation">.</span>appContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>其中 <code>Object.create</code> 其实就是建立原型关系。这时放一张图，一图胜千言。</p> <p><img src="/assets/img/lagou-provides.a779986b.png" alt="直观的图">，出自黄轶老师拉勾专栏，本想自己画一张图，但觉得这张挺好的。</p> <h4 id="_4-6-1-组件实例生成了-那怎么把它们结合呢"><a href="#_4-6-1-组件实例生成了-那怎么把它们结合呢" class="header-anchor">#</a> 4.6.1 组件实例生成了，那怎么把它们结合呢</h4> <p>这时，也有一个讨巧的方法，在<code>runtime-core.esm-bundler.js</code>文件中，搜索 <code>provide(</code>可以搜到如下代码：</p> <p>这段代码其实看起来很复杂的样子，实际上主要就是把用户在组件中写的<code>provides</code>对象或者函数返回值遍历, 生成类似这样的实例对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当前组件实例</span>
<span class="token punctuation">{</span>
  parent<span class="token operator">:</span> <span class="token string">'父级的实例'</span><span class="token punctuation">,</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
    __proto__<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
        __proto__ <span class="token operator">:</span> <span class="token punctuation">{</span> store<span class="token operator">:</span> <span class="token punctuation">{</span> __state<span class="token operator">:</span> <span class="token string">'Store实例'</span> <span class="token punctuation">}</span>  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack:///./node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.js</span>
<span class="token keyword">function</span> <span class="token function">applyOptions</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options<span class="token punctuation">,</span> deferredData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> deferredWatch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> deferredProvide <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> asMixin <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provideOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deferredProvide<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>provideOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asMixin <span class="token operator">&amp;&amp;</span> deferredProvide<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deferredProvide<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">provideOptions</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 组件中写 provides 可以是对象或者是函数</span>
          <span class="token keyword">const</span> provides <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>provideOptions<span class="token punctuation">)</span>
              <span class="token operator">?</span> <span class="token function">provideOptions</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>publicThis<span class="token punctuation">)</span>
              <span class="token operator">:</span> provideOptions<span class="token punctuation">;</span>
          Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>provides<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">provide</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样一来就从上到下<code>app.provide</code>提供的对象，被注入到每一个组件实例中了。同时组件本身提供的<code>provides</code>也被注入到实例中了。</p> <p>接着我们跟着项目来验证下，上文中的表述。翻看<code>Vue3</code>文档可以发现有一个<code>API</code>可以获取当前组件实例。</p> <h3 id="_4-7-getcurrentinstance-获取当前实例对象"><a href="#_4-7-getcurrentinstance-获取当前实例对象" class="header-anchor">#</a> 4.7 getCurrentInstance 获取当前实例对象</h3> <p><code>getCurrentInstance</code> 支持访问内部组件实例，用于高阶用法或库的开发。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getCurrentInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> internalInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    internalInstance<span class="token punctuation">.</span>appContext<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties <span class="token comment">// 访问 globalProperties</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>知道这个API后，我们可以在购物车例子的代码中添加一些代码。便于我们理解。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vuex/examples/composition/shopping-cart/components/App.vue</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getCurrentInstance<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>
<span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'ruochuan12'</span><span class="token punctuation">,</span> <span class="token string">'微信搜索「若川视野」关注我，专注前端技术分享。'</span><span class="token punctuation">)</span>

  window<span class="token punctuation">.</span>AppStore <span class="token operator">=</span> store<span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>AppCurrentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vuex/examples/composition/shopping-cart/components/ProductList.vue</span>
<span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 若川加入的调试代码--start</span>
  window<span class="token punctuation">.</span>ProductListStore <span class="token operator">=</span> store<span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>ProductListCurrentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'weixin-2'</span><span class="token punctuation">,</span> <span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'weixin-3'</span><span class="token punctuation">,</span> <span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'weixin-4'</span><span class="token punctuation">,</span> <span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mp <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> <span class="token string">'介绍-ProductList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 微信搜索「若川视野」关注我，专注前端技术分享。</span>
  <span class="token comment">// 若川加入的调试代码---end</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vuex/examples/composition/shopping-cart/components/ShoppingCart.vue</span>
<span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 若川加入的调试代码--start</span>
    window<span class="token punctuation">.</span>ShoppingCartStore <span class="token operator">=</span> store<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>ShoppingCartCurrentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'weixin'</span><span class="token punctuation">,</span> <span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'weixin1'</span><span class="token punctuation">,</span> <span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'weixin2'</span><span class="token punctuation">,</span> <span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> mp <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'ruochuan12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> <span class="token string">'介绍-ShoppingList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 微信搜索「若川视野」关注我，专注前端技术分享。</span>
    <span class="token comment">// 若川加入的调试代码--start</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在控制台输出这些值</p> <div class="language-js extra-class"><pre class="language-js"><code>AppCurrentInstance
AppCurrentInstance<span class="token punctuation">.</span>provides
ShoppingCartCurrentInstance<span class="token punctuation">.</span>parent <span class="token operator">===</span> AppCurrentInstance <span class="token comment">// true</span>
ShoppingCartCurrentInstance<span class="token punctuation">.</span>provides
ShoppingCartStore <span class="token operator">===</span> AppStore <span class="token comment">// true</span>
ProductListStore <span class="token operator">===</span> AppStore <span class="token comment">// true</span>
AppStore <span class="token comment">// store实例对象</span>
</code></pre></div><p><img src="/assets/img/vuex-provide-inject.71a64224.png" alt="控制台输出的结果"></p> <p>看控制台截图输出的例子，其实跟上文写的类似。这时如果写了顺手自己注入了一个provide('store': '空字符串')，那么顺着原型链，肯定是先找到用户写的<code>store</code>，这时Vuex无法正常使用，就报错了。</p> <p>当然<code>vuex4</code>提供了注入的<code>key</code>可以不是<code>store</code>的写法，这时就不和用户的冲突了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>
    <span class="token comment">// 省略若干代码...</span>
    <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> injectKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 为 composition API 中使用</span>
        <span class="token comment">//  可以传入 injectKey  如果没传取默认的 storeKey 也就是 store</span>
        app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>injectKey <span class="token operator">||</span> storeKey<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 为 option API 中使用</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略若干代码...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useStore</span> <span class="token punctuation">(</span><span class="token parameter">key <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> key <span class="token operator">:</span> storeKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-解答下开头提出的5个问题"><a href="#_5-解答下开头提出的5个问题" class="header-anchor">#</a> 5. 解答下开头提出的5个问题</h2> <p>统一解答下开头提出的5个问题：</p> <p>1、为什么修改了实例<code>store</code>里的属性，变更后会触发视图更新。</p> <p>答：使用<code>Vue</code> 中的 <code>reactive</code> 方法监测数据变化的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 省略若干代码...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">.</span>state
    <span class="token function">resetStoreState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token comment">// 省略若干代码...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">resetStoreState</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略若干代码...</span>
  store<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token operator">:</span> state
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 省略若干代码...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2、<code>Vuex4</code>作为<code>Vue</code>的插件如何实现和<code>Vue</code>结合的。</p> <p>答：<code>app.use(store)</code> 时会执行<code>Store</code>中的<code>install</code>方法，一句是为 <code>composition API</code> 中使用，提供<code>Store</code>实例对象到根实例中。一句则是注入到根实例的全局属性中，为 <code>option API</code> 中使用。它们都会在组件生成时，注入到每个组件实例中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>
    <span class="token comment">// 省略若干代码...</span>
    <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> injectKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 为 composition API 中使用</span>
        <span class="token comment">//  可以传入 injectKey  如果没传取默认的 storeKey 也就是 store</span>
        app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>injectKey <span class="token operator">||</span> storeKey<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 为 option API 中使用</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略若干代码...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3、<code>provide</code>、<code>inject</code>的如何实现的，每个组件如何获取到组件实例中的<code>Store</code>的。</p> <p>5、为什么在组件中写的<code>provide</code>提供的数据，能被子级组件获取到。</p> <p>答：<code>provide</code>函数建立原型链区分出组件实例用户自己写的属性和系统注入的属性。<code>inject</code>函数则是通过原型链找父级实例中的<code>provides</code>对象中的属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 有删减</span>
<span class="token keyword">function</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> provides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
    <span class="token keyword">const</span> parentProvides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> currentInstance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentProvides <span class="token operator">===</span> provides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        provides <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>provides <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parentProvides<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 有删减</span>
<span class="token keyword">function</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> provides <span class="token operator">=</span> instance<span class="token punctuation">.</span>parent <span class="token operator">==</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>appContext <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>appContext<span class="token punctuation">.</span>provides
        <span class="token operator">:</span> instance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>provides <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> provides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也就是类似这样的实例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当前组件实例</span>
<span class="token punctuation">{</span>
  parent<span class="token operator">:</span> <span class="token string">'父级的实例'</span><span class="token punctuation">,</span>
  provides<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
    __proto__<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 可以容纳其他属性，比如用户自己写的</span>
        __proto__ <span class="token operator">:</span> <span class="token punctuation">{</span> store<span class="token operator">:</span> <span class="token punctuation">{</span> __state<span class="token operator">:</span> <span class="token string">'Store实例'</span> <span class="token punctuation">}</span>  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>4、为什么每个组件对象里都有<code>Store</code>实例对象了(渲染组件对象过程)。</p> <p>答：渲染生成组件实例时，调用<code>createComponentInstance</code>，注入到组件实例的<code>provides</code>中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> suspense</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">const</span> appContext <span class="token operator">=</span> <span class="token punctuation">(</span>parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>appContext <span class="token operator">:</span> vnode<span class="token punctuation">.</span>appContext<span class="token punctuation">)</span> <span class="token operator">||</span> emptyAppContext<span class="token punctuation">;</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">,</span>
        appContext<span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
        provides<span class="token operator">:</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>provides <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>appContext<span class="token punctuation">.</span>provides<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li>你怎么知道那么多的</li></ol> <p>答：因为社区有人写了<a href="https://lxchuan12.gitee.io/vuex4" target="_blank" rel="noopener noreferrer"><code>Vue4</code>源码文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="_6-总结"><a href="#_6-总结" class="header-anchor">#</a> 6. 总结</h2> <p>本文主要讲述了<code>Vuex4</code>把<code>Store</code>实例注入到各个组件中的原理，展开讲述了<code>Vuex4</code>相对与<code>Vuex3</code>安装方式的改变<code>Vuex.createStore</code>、<code>app.use(store)</code> ，深入源码分析<code>Vue.inject</code>、<code>Vue.provide</code>实现原理。</p> <p><code>Vuex4</code> 除了安装方式和监测数据变化方式使用了<code>Vue.reactive</code>，其他基本和<code>Vuex3.x</code>版本没什么区别。</p> <p>最后回顾下文章开头的图，可以说就是原型链的妙用。</p> <p><img src="/assets/img/components_provide.6bb18cde.png" alt="provide,inject示例图"></p> <p>是不是觉得豁然开朗。</p> <p><code>Vuex</code>其实也是<code>Vue</code>的一个插件，知晓了<code>Vuex</code>原理，对于自己给<code>Vue</code>写插件也是会游刃有余。</p> <blockquote><p>如果读者朋友发现有不妥或可改善之处，再或者哪里没写明白的地方，欢迎评论指出，也欢迎加我微信 <code>ruochuan12</code> 交流。另外觉得写得不错，对您有些许帮助，可以点赞、评论、转发分享，也是对我的一种支持，万分感谢。如果能关注我的前端公众号：<a href="https://mp.weixin.qq.com/s/c3hFML3XN9KCUetDOZd-DQ" target="_blank" rel="noopener noreferrer">「若川视野」<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，就更好啦。</p></blockquote> <h2 id="关于"><a href="#关于" class="header-anchor">#</a> 关于</h2> <blockquote><p>你好，我是<a href="https://lxchuan12.gitee.io" target="_blank" rel="noopener noreferrer">若川<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，微信搜索<a href="https://mp.weixin.qq.com/s/c3hFML3XN9KCUetDOZd-DQ" target="_blank" rel="noopener noreferrer">「若川视野」<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>关注我，专注前端技术分享，一个愿景是帮助5年内前端开阔视野走向前列的公众号。欢迎加我微信<code>ruochuan12</code>，长期交流学习。
主要有以下系列文章：<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA5MjQwMzQyNw==&amp;action=getalbum&amp;album_id=1342211915371675650#wechat_redirect" target="_blank" rel="noopener noreferrer">学习源码整体架构系列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA5MjQwMzQyNw==&amp;action=getalbum&amp;album_id=1668518390266724360#wechat_redirect" target="_blank" rel="noopener noreferrer">年度总结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA5MjQwMzQyNw==&amp;action=getalbum&amp;album_id=1342989113611419648#wechat_redirect" target="_blank" rel="noopener noreferrer">JS基础系列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <p><a href="https://v3.cn.vuejs.org/guide/composition-api-provide-inject.html" target="_blank" rel="noopener noreferrer">官网文档 Provide / Inject<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://github.com/vuejs/vue-next/blob/HEAD/packages/runtime-core/src/apiInject.ts" target="_blank" rel="noopener noreferrer">github 仓库 provide/inject 源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://github.com/vuejs/vue-next/blob/HEAD/packages/runtime-core/__tests__/apiInject.spec.ts" target="_blank" rel="noopener noreferrer">github 仓库 provide/inject 测试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://next.vuex.vuejs.org/zh/" target="_blank" rel="noopener noreferrer">Vuex 4 官方中文文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">5/19/2021, 1:13:16 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/" class="prev router-link-active">
        目录
      </a></span> <span class="next"><a href="/open-in-editor/">
        据说 99% 的人不知道 vue-devtools 还能直接打开对应组件文件？本文原理揭秘
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><BackToTop></BackToTop><!----></div></div>
    <script src="/assets/js/app.aca9512d.js" defer></script><script src="/assets/js/2.bb92df1b.js" defer></script><script src="/assets/js/17.8efc7454.js" defer></script><script src="/assets/js/25.52480ac0.js" defer></script>
  </body>
</html>
